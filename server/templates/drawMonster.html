<!DOCTYPE html>
{%extends 'loggedinheader.html' %}
<meta charset="utf-8" />
<style>
    @import url(https://fonts.googleapis.com/css?family=Open+Sans);

    #color-input {
        display: none;
    }

    #color-label {
        margin-left: 15px;
        position: absolute;
        height: 30px;
        width: 50px;
    }

    #color-input:checked ~ #color-picker {
        opacity: 1;
    }

    #color-picker {
        position: absolute;
        left: 70px;
        background-color: white;
        height: 150px;
        width: 185px;
        border: solid 1px #ccc;
        opacity: 0;
        padding: 5px;
    }

    #color-strip:hover {
        cursor: crosshair;
    }
    #paint {
        border: 5px solid #000000;
        margin: 10px 20px;
        display: inline-block;
        position: relative;
    }
    #panel {
        border: 2px solid #E8fcff;
        padding: 20px 20px 20px 20px;
        background-color: #273238;
    }
</style>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
<script src="http://code.createjs.com/easeljs-0.5.0.min.js"></script>
<script type="text/javascript" src="libs/upclick-min.js">

{% block content %}
<body onload="pencil()">
    <h1>MonsterEditor</h1>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
        <table>
        <td>

            <button id="reset" value="pencil" onclick="change(this.value)"><img src="/static/assets/pencilicon.png" alt="Pencil" style="width:60px; height:55px"></button>
                <button id="reset" value="line" onclick="change(this.value)"><img src="/static/assets/linetool.png" alt="Line" style="width:60px; height:55px"></button>
            </td>
                <td>
                    <button id="reset" value="rectangle" onclick="change(this.value)"><img src="/static/assets/squaretool.png" alt="Rectangle" style="width:60px; height:55px"></button>
                        <button id="reset" value="circle" onclick="change(this.value)"><img src="/static/assets/circletool.png" alt="Circle" style="width:60px; height:55px"></button>
      </td><td>
      <button id="reset" value="eraser" onclick="change(this.value)"><img src="/static/assets/erasertool.png" alt="Eraser" style="width:60px; height:55px"></button>
    </td></table>
    <div style= 'float:left; margin: 10px 20px;'>
        <canvas id="paint" width="450" height="630" ></canvas>
        </div>
        <div id="panel">
            <div id="color-picker">
                <canvas id="color-block" height="150" width="150"></canvas>
                <canvas id="color-strip" height="150" width="30"></canvas>
            </div>
        </div>
    <div position = 'relative'>
        <fieldset id="colorset" width="450" height="630">
        <table width=50% height=100% >
            <label> Options: <select id="optionsselect" onchange="change(this.value)" style="height: 30px; width: 90px;">
                <option value="fill">Fill</option>
                <option value="outline">Outline</option>
            </select></label>

    <td>
        <label> Line Width: </label>
            <button id="reset" type="button" onclick="add_pixel()" style="width: 50px; font-size:2em;">+</button>
            <button id="reset" type="button" onclick="reduce_pixel()" style="width: 50px; font-size:2em;">-</button>
          </td>
    </fieldset>
    </div>

   
    

    <div sytle= 'float:right'>
    <fieldset>
            </table>
        <label>Style: <select id="fontselect" onchange="font(this.value)" style="height: 30px; width: 100px;">
            <option value="20px Arial">Small Arial</option>
            <option value="30px Arial">Medium Arial</option>
            <option value="40px Arial">Large Arial</option>
            <option value="20px Comic Sans">Small Comic Sans</option>
            <option value="30px Comic Sans">Medium Comic Sans</option>
            <option value="40px Comic Sans">Large Comic Sans</option>
    </select></label>


    <label>Text: </label><input id="fname" type="text" onchange="text(this.value)">

    <label>Vertical Text Height: </label><input type="range" min="2" max="99" value="2" class="slider" id="myRange" oninput="changeVert(this.value)">

    <label>Horizontal Text Height: </label><input type="range" min="1" max="97" value="1" class="slider" id="myRange" oninput="changeHorzt(this.value)">

    </fieldset>
    </div>

    <div sytle= 'float:right'>
    <fieldset>
        <form id="upload-img-form" enctype="multipart/form-data">
            <label>Upload Image: </label>
            <input type="file" id="monster-image" name="monster-image" accept="image/png, image/jpeg">
            <button type="button" id="reset" onclick="uploadImage_ajax()">Upload</button>
        </form>
    </fieldset>
    </div>

    <div sytle= 'float:right'>
    <fieldset>
            <label>Monster Name: </label><input id="fname" type="text"><button id="reset" onclick="save()">Save</button>
            <button id="reset" onclick="reset()">Reset</button>
    </fieldset>
    </div>




<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
<script src=" {{ url_for('static', filename='script.js') }}"></script>

<script>

    var canvas = document.getElementById("paint");
    var ctx = canvas.getContext("2d");
    var width = canvas.width;
    var height = canvas.height;
    var curX, curY, prevX, prevY;
    var hold = false;
    ctx.lineWidth = 2;
    var fill_value = true;
    var stroke_value = false;
    var colorBlock = document.getElementById('color-block');
    var ctx1 = colorBlock.getContext('2d');
    var width1 = colorBlock.width;
    var height1 = colorBlock.height;
    var colorStrip = document.getElementById('color-strip');
    var ctx2 = colorStrip.getContext('2d');
    var width2 = colorStrip.width;
    var height2 = colorStrip.height;

            var colorLabel = document.getElementById('color-label');

            var x = 0;
            var y = 0;
     var drag = false;
     var rgbaColor = 'rgba(255,0,0,1)';
var canvas_data = {"pencil": [], "line": [], "rectangle": [], "circle": [], "eraser": [], "text": [], "upload": []}

    var vert =  (2/100)*630;
    var horzt =  (1/100)*450;

    reset();


function change(type) {
if (type == "pencil") {
        pencil();
    }
if (type == "line") {
        line();
    }
if (type == "rectangle") {
        rectangle();
    }
if (type == "circle") {
        circle();
    }
if (type == "eraser") {
        eraser();
    }
if (type == "upload") {
        //check if new design ...
        upload();
    }
if (type == "fill") {
        fill();
    }
if (type == "outline") {
        outline();
    }
}

function color(color_value){
        ctx.strokeStyle = color_value;
    ctx.fillStyle = color_value;
}
ctx1.rect(0, 0, width1, height1);
            fillGradient();

            ctx2.rect(0, 0, width2, height2);
            var grd1 = ctx2.createLinearGradient(0, 0, 0, height1);
            grd1.addColorStop(0, 'rgba(255, 0, 0, 1)');
            grd1.addColorStop(0.17, 'rgba(255, 255, 0, 1)');
            grd1.addColorStop(0.34, 'rgba(0, 255, 0, 1)');
            grd1.addColorStop(0.51, 'rgba(0, 255, 255, 1)');
            grd1.addColorStop(0.68, 'rgba(0, 0, 255, 1)');
            grd1.addColorStop(0.85, 'rgba(255, 0, 255, 1)');
            grd1.addColorStop(1, 'rgba(255, 0, 0, 1)');
            ctx2.fillStyle = grd1;
            ctx2.fill();

            function click(e) {
                x = e.offsetX;
                y = e.offsetY;
                var imageData = ctx2.getImageData(x, y, 1, 1).data;
                rgbaColor = 'rgba(' + imageData[0] + ',' + imageData[1] + ',' + imageData[2] + ',1)';
                fillGradient();
            }

            function fillGradient() {
                ctx1.fillStyle = rgbaColor;
                ctx1.fillRect(0, 0, width1, height1);

                var grdWhite = ctx2.createLinearGradient(0, 0, width1, 0);
                grdWhite.addColorStop(0, 'rgba(255,255,255,1)');
                grdWhite.addColorStop(1, 'rgba(255,255,255,0)');
                ctx1.fillStyle = grdWhite;
                ctx1.fillRect(0, 0, width1, height1);

                var grdBlack = ctx2.createLinearGradient(0, 0, 0, height1);
                grdBlack.addColorStop(0, 'rgba(0,0,0,0)');
                grdBlack.addColorStop(1, 'rgba(0,0,0,1)');
                ctx1.fillStyle = grdBlack;
                ctx1.fillRect(0, 0, width1, height1);
            }

            function mousedown(e) {
                drag = true;
                changeColor(e);
            }

            function mousemove(e) {
                if (drag) {
                    changeColor(e);
                }
            }

            function mouseup(e) {
                drag = false;
            }

            function changeColor(e) {
                x = e.offsetX;
                y = e.offsetY;
                var imageData = ctx1.getImageData(x, y, 1, 1).data;
                rgbaColor = 'rgba(' + imageData[0] + ',' + imageData[1] + ',' + imageData[2] + ',1)';
                colorLabel.style.backgroundColor = rgbaColor;
                color(rgbaColor);
            }

            colorStrip.addEventListener("click", click, false);

            colorBlock.addEventListener("mousedown", mousedown, false);
            colorBlock.addEventListener("mouseup", mouseup, false);
            colorBlock.addEventListener("mousemove", mousemove, false);

function font(font_value){
        ctx.font = font_value;
    }

function changeVert(v){
        vert = (v / 100) * 630;
    }

function changeHorzt(h){
        horzt = (h / 100) * 450;
    }

function add_pixel(){
        ctx.lineWidth += 1;
    }

function reduce_pixel(){
if (ctx.lineWidth == 1){
        ctx.lineWidth = 1;
    } else{
        ctx.lineWidth -= 1;
    }
}

function fill(){
        fill_value = true;
    stroke_value = false;
}

function outline(){
        fill_value = false;
    stroke_value = true;
}

function reset(){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    canvas_data = {"pencil": [], "line": [], "rectangle": [], "circle": [], "eraser": [], "text": [], "upload": []}
    var oldcolor = ctx.strokeStyle;
    color("#FFFFFF");
    ctx.strokeRect(0, 0, 450, 630);
if (fill_value){
        ctx.fillRect(0, 0, 450, 630);
    }
    color(oldcolor);
}

// pencil tool

function pencil(){

        canvas.onmousedown = function (e) {
            curX = e.clientX - canvas.offsetLeft;
            curY = e.clientY - canvas.offsetTop;
            hold = true;

            prevX = curX;
            prevY = curY;
            ctx.beginPath();
            ctx.moveTo(prevX, prevY);
        };

    canvas.onmousemove = function(e){
if(hold){
        curX = e.clientX - canvas.offsetLeft;
    curY = e.clientY - canvas.offsetTop;
    draw();
}
};

canvas.onmouseup = function(e){
        hold = false;
    };

canvas.onmouseout = function(e){
        hold = false;
    };

function draw(){
        ctx.lineTo(curX, curY);
    ctx.stroke();
canvas_data.pencil.push({"startx": prevX, "starty": prevY, "endx": curX, "endy": curY, "thick": ctx.lineWidth, "color": ctx.strokeStyle });
}
}

// line tool

function line(){

        canvas.onmousedown = function (e) {
            img = ctx.getImageData(0, 0, width, height);
            prevX = e.clientX - canvas.offsetLeft;
            prevY = e.clientY - canvas.offsetTop;
            hold = true;
        };

    canvas.onmousemove = function linemove(e){
if (hold){
        ctx.putImageData(img, 0, 0);
    curX = e.clientX - canvas.offsetLeft;
    curY = e.clientY - canvas.offsetTop;
    ctx.beginPath();
    ctx.moveTo(prevX, prevY);
    ctx.lineTo(curX, curY);
    ctx.stroke();
canvas_data.line.push({"starx": prevX, "starty": prevY, "endx": curX, "endY": curY, "thick": ctx.lineWidth, "color": ctx.strokeStyle });
    ctx.closePath();
}
};

canvas.onmouseup = function (e){
        hold = false;
    };

canvas.onmouseout = function (e){
        hold = false;
    };
}

// rectangle tool

function rectangle(){

        canvas.onmousedown = function (e) {
            img = ctx.getImageData(0, 0, width, height);
            prevX = e.clientX - canvas.offsetLeft;
            prevY = e.clientY - canvas.offsetTop;
            hold = true;
        };

    canvas.onmousemove = function (e){
if (hold){
        ctx.putImageData(img, 0, 0);
    curX = e.clientX - canvas.offsetLeft - prevX;
    curY = e.clientY - canvas.offsetTop - prevY;
    ctx.strokeRect(prevX, prevY, curX, curY);
if (fill_value){
        ctx.fillRect(prevX, prevY, curX, curY);
    }
canvas_data.rectangle.push({"starx": prevX, "stary": prevY, "width": curX, "height": curY, "thick": ctx.lineWidth, "stroke": stroke_value, "stroke_color": ctx.strokeStyle, "fill": fill_value, "fill_color": ctx.fillStyle });
}
};

canvas.onmouseup = function(e){
        hold = false;
    };

canvas.onmouseout = function(e){
        hold = false;
    };
}

// circle tool

function circle(){

        canvas.onmousedown = function (e) {
            img = ctx.getImageData(0, 0, width, height);
            prevX = e.clientX - canvas.offsetLeft;
            prevY = e.clientY - canvas.offsetTop;
            hold = true;
        };

    canvas.onmousemove = function (e){
if (hold){
        ctx.putImageData(img, 0, 0);
    curX = e.clientX - canvas.offsetLeft;
    curY = e.clientY - canvas.offsetTop;
    ctx.beginPath();
    ctx.arc(Math.abs(curX + prevX)/2, Math.abs(curY + prevY)/2, Math.sqrt(Math.pow(curX - prevX, 2) + Math.pow(curY - prevY, 2))/2, 0, Math.PI * 2, true);
    ctx.closePath();
    ctx.stroke();
if (fill_value){
        ctx.fill();
    }
canvas_data.circle.push({"starx": prevX, "stary": prevY, "radius": curX - prevX, "thick": ctx.lineWidth, "stroke": stroke_value, "stroke_color": ctx.strokeStyle, "fill": fill_value, "fill_color": ctx.fillStyle });
    }
};

canvas.onmouseup = function (e){
        hold = false;
    };

canvas.onmouseout = function (e){
        hold = false;
    };
}

// eraser tool

function eraser(){

        canvas.onmousedown = function (e) {
            curX = e.clientX - canvas.offsetLeft;
            curY = e.clientY - canvas.offsetTop;
            hold = true;

            prevX = curX;
            prevY = curY;
            ctx.beginPath();
            ctx.moveTo(prevX, prevY);
        };

    canvas.onmousemove = function(e){
if(hold){
        curX = e.clientX - canvas.offsetLeft;
    curY = e.clientY - canvas.offsetTop;
    draw();
}
};

canvas.onmouseup = function(e){
        hold = false;
    };

canvas.onmouseout = function(e){
        hold = false;
    };

function draw(){
        ctx.lineTo(curX, curY);
    ctx.strokeStyle = "#ffffff";
    ctx.stroke();
canvas_data.pencil.push({"startx": prevX, "starty": prevY, "endx": curX, "endy": curY, "thick": ctx.lineWidth, "color": ctx.strokeStyle });
}
}

function text(words){
        ctx.fillText(words, horzt, vert); //horzt, vert
    canvas_data.line.push({"starx": horzt, "starty": vert, "text": words, "font": ctx.font, "color": ctx.strokeStyle })
}

function upload() {
    uploadImage_ajax();
    /**
    * UPLOAD SCRIPT
    * This script uses the UploadAtClick library to upload files on a webserver folder
    * using a PHP script ("upload/upload.php")
    * Project homepage: http://code.google.com/p/upload-at-click/
    */
    // upclick(
    // {
    //         element: uploader,
    //     action: 'upload/upload.php', //need to fix
    //     onstart:
    // function(filename)
    // {
    //         //alert('Start upload: '+filename);
    //     },
    //         oncomplete:
    //     function(response_data)
    // {
    // // Check upload Status
    // if (response_data != "FAIL") {
    //         // Draw the picture into Canvas
    //         // "response_data" contains the image file name returned from the PHP script
    //         displayPicture("upload/" + response_data);
    //     }
    // }
    //     });



}

function uploadImage_ajax() {
    var uploader = document.getElementById('uploader');
    var fd = new FormData($("#upload-img-form")[0]);

    $.ajax({
        url: '/editor/upload-img',
        data: fd,
        cache:false,
        processData:false,
        contentType:false,
        type: 'POST',
        success: function(data){
            console.log(data);
            if ("error" in data) {

            }
            else if ("success" in data) {
                
            }
        }
    });
}

function save(){
var filename = document.getElementById("fname").value;
    var data = JSON.stringify(canvas_data);
    var image = canvas.toDataURL();

$.post("/", {save_fname: filename, save_cdata: data, save_image: image });
    alert(filename + " saved");

    //redirect to page that was on
}


function reload(){
    }

</script>

</body>
{% endblock %}